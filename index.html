<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <link rel="stylesheet" href="./styles.css">
  <title>Wordle by Joxter</title>
</head>
<body>
<div class="container">
  <div>
    <header>
      <h1 style="text-align: center; margin: 8px 0;">Wordle<span class="title-label">Joxter</span></h1>
      <div class="rules" id="rules" style="display:none;">
        <p>You have 6 guesses to guess the correct word.</p>
        <p>You can guess any valid word.</p>
        <p>After each guess, each letter will turn green, yellow, or gray.</p>
        <p><span class="green">A</span> - Correct letter, correct spot</p>
        <p><span class="yellow">B</span> - Correct letter, wrong spot</p>
      </div>
      <div style="text-align: center">
        <button class="rules-btn" type="button" id="rules-btn">How to play?</button>
      </div>

    </header>
    <div class="board" id="board">
      <div class="box"></div>
      <div class="box"></div>
      <div class="box"></div>
      <div class="box"></div>
      <div class="box"></div>
      <div class="box"></div>
      <div class="box"></div>
      <div class="box"></div>
      <div class="box"></div>
      <div class="box"></div>
      <div class="box"></div>
      <div class="box"></div>
      <div class="box"></div>
      <div class="box"></div>
      <div class="box"></div>
      <div class="box"></div>
      <div class="box"></div>
      <div class="box"></div>
      <div class="box"></div>
      <div class="box"></div>
      <div class="box"></div>
      <div class="box"></div>
      <div class="box"></div>
      <div class="box"></div>
      <div class="box"></div>
      <div class="box"></div>
      <div class="box"></div>
      <div class="box"></div>
      <div class="box"></div>
      <div class="box"></div>
    </div>
  </div>
  <div>
    <div class="result-cont">
      <button type="button" class="restart-btn" id="restart">New game</button>
      <p id="secret" class="secret">secret</p>
    </div>
  </div>
  <div class="keyboard" id="keyboard">
    <div class="row">
      <button type="button" id="letter-q">q</button>
      <button type="button" id="letter-w">w</button>
      <button type="button" id="letter-e">e</button>
      <button type="button" id="letter-r">r</button>
      <button type="button" id="letter-t">t</button>
      <button type="button" id="letter-y">y</button>
      <button type="button" id="letter-u">u</button>
      <button type="button" id="letter-i">i</button>
      <button type="button" id="letter-o">o</button>
      <button type="button" id="letter-p">p</button>
    </div>
    <div class="row">
      <button type="button" id="letter-a">a</button>
      <button type="button" id="letter-s">s</button>
      <button type="button" id="letter-d">d</button>
      <button type="button" id="letter-f">f</button>
      <button type="button" id="letter-g">g</button>
      <button type="button" id="letter-h">h</button>
      <button type="button" id="letter-j">j</button>
      <button type="button" id="letter-k">k</button>
      <button type="button" id="letter-l">l</button>
    </div>
    <div class="row">
      <button type="button" id="delete">del</button>
      <button type="button" id="letter-z">z</button>
      <button type="button" id="letter-x">x</button>
      <button type="button" id="letter-c">c</button>
      <button type="button" id="letter-v">v</button>
      <button type="button" id="letter-b">b</button>
      <button type="button" id="letter-n">n</button>
      <button type="button" id="letter-m">m</button>
      <button type="button" id="enter">enter</button>
    </div>
  </div>
</div>
<script>
  let keyboardEL = document.querySelector('#keyboard');
  let boardEL = document.querySelector('#board');
  let deleteEL = document.querySelector('#delete');
  let enterEL = document.querySelector('#enter');
  let restartEL = document.querySelector('#restart');
  let secretEL = document.querySelector('#secret');
  let rulesEL = document.querySelector('#rules');
  let rulesBtnEL = document.querySelector('#rules-btn');
  let boxesEL = document.querySelectorAll('#board .box');

  let dictionary = new Set(['qwert', 'asdfg', 'zxcvb']);
  let alphabet = new Set('qwertyuiopasdfghjklzxcvbnm'.split(''));

  let stage; // going win fail
  let secretWord;
  let attempts;
  let currentInput;

  try {
    stage = getSaved('stage') || 'going';
    secretWord = getSaved('secretWord') || getRandomWord();
    attempts = getSaved('attempts') || [];
    currentInput = [];

    toggleButtons();
    firstRender();

    rulesBtnEL.addEventListener('click', () => {
      if (rulesEL.style.display) {
        rulesEL.style.display = '';
        rulesBtnEL.innerHTML = 'Ok, close the rules';
      } else {
        rulesEL.style.display = 'none';
        rulesBtnEL.innerHTML = 'How to play?';
      }
    });
    restartEL.addEventListener('click', () => startNewGame());

    document.addEventListener('keydown', (ev) => {
      if (ev.key === 'Enter') {
        if (stage === 'win' || stage === 'fail') {
          startNewGame();
        } else {
          submitWord();
        }
      } else if (ev.key === 'Backspace') {
        removeLetter();
      } else if (alphabet.has(ev.key.toLowerCase())) {
        printLetter(ev.key);
      }
    });

    keyboardEL.addEventListener('click', (ev) => {
      if (ev.target.nodeName === 'BUTTON') {
        if (ev.target === deleteEL) {
          removeLetter();
        } else if (ev.target === enterEL) {
          submitWord();
        } else {
          printLetter(ev.target.innerText);
        }
      }
    });

  } catch (err) {
    console.error(err);
    localStorage.clear();
    alert('Something went wrong:(\nPlease try refreshing the page');
  }

  function paintOverKeyboardKey(letter, color) {
    let keyboardLetter = document.querySelector(`#letter-${letter}`);
    if (color === 'green') {
      keyboardLetter.classList.add('green');
      keyboardLetter.classList.remove('yellow');
    } else if (color === 'yellow') {
      keyboardLetter.classList.add('yellow');
    }
  }

  function printLetter(letter) {
    if (stage === 'going' && currentInput.length < 5) {
      currentInput.push(letter);
      boxesEL[attempts.length * 5 + currentInput.length - 1].innerHTML = letter;

      toggleButtons();
    }
  }

  function removeLetter() {
    if (stage === 'going' && currentInput.length > 0) {
      currentInput.pop();
      boxesEL[attempts.length * 5 + currentInput.length].innerHTML = '';

      toggleButtons();
    }
  }

  function submitWord() {
    if (stage !== 'going' || currentInput.length < 5) {
      alert('Should be 5 letters');
      return;
    }

    if (!dictionary.has(currentInput.join(''))) {
      alert(`Can't find a word "${currentInput.join('')}" :(`);
      return;
    }

    let attempt = compareWords();
    let revealed = addAttempt(attempt);
    saveState();

    if (revealed) {
      toWin();
      localStorage.clear();
    } else if (attempts.length === 6) {
      toFail();
      localStorage.clear();
    }
    toggleButtons();
  }

  function saveState() {
    save('stage', stage);
    save('secretWord', secretWord);
    save('attempts', attempts);
  }

  function toWin() {
    stage = 'win';
    secretEL.style.display = 'block';
    secretEL.innerHTML = 'Congratulations!';
  }

  function toFail() {
    stage = 'fail';
    secretEL.style.display = 'block';
    secretEL.innerHTML = `Oops:( The word was ${secretWord.toUpperCase()}`;
  }

  function startNewGame() {
    secretWord = getRandomWord();
    stage = 'going';
    attempts = [];
    currentInput = [];
    restartEL.blur();

    secretEL.style.display = '';
    boxesEL.forEach(el => {
      el.innerHTML = '';
      el.classList.remove('green');
      el.classList.remove('yellow');
    });
    keyboardEL.querySelectorAll('button').forEach(el => {
      el.classList.remove('green');
      el.classList.remove('yellow');
    });

    saveState();
    toggleButtons();
  }

  function getRandomWord() {
    let rand = Math.floor(Math.random() * dictionary.size);

    let i = 0;
    for (let word of dictionary) {
      if (i === rand) return word;
      i++;
    }

    return 'table';
  }

  function compareWords() {
    let res = [];

    for (let i = 0; i < 5; i++) {
      let color = null;

      if (currentInput[i] === secretWord[i]) {
        color = 'green';
      } else if (secretWord.includes(currentInput[i])) {
        color = 'yellow';
      }
      res.push({color, letter: currentInput[i]});
    }

    return res;
  }

  function addAttempt(attempt) {
    if (stage !== 'going') return;

    let revealed = true;
    for (let i = 0; i < 5; i++) {
      const {color, letter} = attempt[i];
      if (color !== 'green') revealed = false;

      if (color) {
        // todo add animations
        boxesEL[attempts.length * 5 + i].classList.add(color);
        paintOverKeyboardKey(letter, color);
      }
    }
    attempts.push(attempt);
    currentInput = [];

    return revealed;
  }

  function firstRender() {
    let i = 0;
    attempts.forEach(attempt => {
      attempt.forEach(({color, letter}) => {
        boxesEL[i].classList.add(color);
        boxesEL[i].innerHTML = letter;
        paintOverKeyboardKey(letter, color);
        i++;
      });
    });
  }

  function toggleButtons() {
    deleteEL.toggleAttribute('disabled', currentInput.length === 0);
    enterEL.toggleAttribute('disabled', currentInput.length < 5);
  }

  function save(key, value) {
    try {
      return localStorage.setItem(key, JSON.stringify(value));
    } catch (err) {
      return null;
    }
  }

  function getSaved(key) {
    try {
      return JSON.parse(localStorage.getItem(key));
    } catch (err) {
      return null;
    }
  }
</script>
</body>
</html>